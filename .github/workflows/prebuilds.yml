name: prebuilds
on: push

permissions:
  contents: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    container:
      image: ${{ matrix.os == 'ubuntu-22.04' && 'debian:10-slim' || null }}
    strategy:
      matrix:
        os: [macos-12, ubuntu-22.04, windows-2022]
    steps:
      - name: Install system dependencies
        run: apt-get update && apt-get -y install g++ git jq make python3
        if: runner.os == 'Linux'
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          submodules: recursive
      - uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4
        with:
          node-version: 18
          cache: npm
      - run: npm ci --ignore-scripts
      - run: bash .github/prebuild.sh
        env:
          JOBS: 3
      - run: bash .github/prebuild.sh arm64
        if: runner.os == 'macOS'
        env:
          JOBS: 3
      - name: Upload prebuilds
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4
        with:
          name: prebuilds-${{ matrix.os }}
          path: prebuilds/
