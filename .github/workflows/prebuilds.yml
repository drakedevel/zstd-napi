name: prebuilds
on: push

permissions:
  contents: read

jobs:
  build-prebuilds:
    runs-on: ${{ matrix.os }}
    container:
      image: ${{ matrix.os == 'ubuntu-22.04' && 'debian:10-slim' || null }}
    strategy:
      matrix:
        os: [macos-12, ubuntu-22.04, windows-2022]
    env:
      JOBS: 3
    steps:
      - name: Install system dependencies
        run: apt-get update && apt-get -y install g++ g++-aarch64-linux-gnu g++-arm-linux-gnueabihf git jq make python3
        if: runner.os == 'Linux'
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          submodules: recursive
      - uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4
        with:
          node-version-file: .node-version
          cache: npm
      - run: npm ci --ignore-scripts
      - name: Build x64
        run: bash .github/prebuild.sh
      - name: Build arm
        run: bash .github/prebuild.sh arm
        if: runner.os == 'Linux'
        env:
          CC: arm-linux-gnueabihf-gcc
          CXX: arm-linux-gnueabihf-g++
      - name: Build arm64
        run: |
          ${{runner.os == 'Linux' }} && export CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++
          bash .github/prebuild.sh arm64
        if: runner.os == 'Linux' || runner.os == 'macOS'
      - name: Build ia32
        run: bash .github/prebuild.sh ia32
        if: runner.os == 'Windows'
      - name: Upload prebuilds
        uses: actions/upload-artifact@1eb3cb2b3e0f29609092a73eb033bb759a334595 # v4
        with:
          name: prebuilds-${{ matrix.os }}
          path: prebuilds/
